<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S·ª± Th·∫≠t hay H∆∞ C·∫•u - AI Vision</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Be Vietnam Pro', sans-serif; touch-action: manipulation; }
        .card-enter { opacity: 0; transform: translateY(20px) scale(0.95); }
        .card-enter-active { opacity: 1; transform: translateY(0) scale(1); transition: opacity 300ms, transform 300ms; }
        .feedback-correct { box-shadow: 0 0 15px 5px rgba(34, 197, 94, 0.6); }
        .feedback-incorrect { box-shadow: 0 0 15px 5px rgba(239, 68, 68, 0.6); }
        .spinner { width: 40px; height: 40px; border: 5px solid rgba(0, 0, 0, 0.1); border-left-color: #4f46e5; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .topic-btn, .level-btn { transition: all 0.2s ease-in-out; }
        .topic-btn:hover, .level-btn:hover { transform: scale(1.05); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .vote-btn { transition: transform 0.2s, color 0.2s; }
        .vote-btn:hover { transform: scale(1.2); }
        .vote-btn.voted-like { color: #22c55e; }
        .vote-btn.voted-dislike { color: #ef4444; }
        .vote-btn:disabled { cursor: not-allowed; opacity: 0.7; }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.6); display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; z-index: 50; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal-content { background: white; padding: 24px; border-radius: 16px; width: 90%; max-width: 600px; max-height: 80vh; overflow-y: auto; transform: scale(0.95) translateY(10px); transition: transform 0.3s ease; position: relative; }
        .modal-overlay.active .modal-content { transform: scale(1) translateY(0); }
        .dark .modal-content { background: #1e293b; }
        .modal-close-btn { position: absolute; top: 12px; right: 12px; background: #e2e8f0; border-radius: 9999px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: background-color 0.2s; }
        .dark .modal-close-btn { background: #334155; }
        
        .markdown-content h3 { font-size: 1.25rem; font-weight: 700; margin-bottom: 8px; margin-top: 1rem; }
        .dark .markdown-content h3 { color: inherit; }
        .markdown-content ul { list-style-type: disc; padding-left: 20px; margin-top: 8px; }
        .markdown-content li { margin-bottom: 4px; }
        .markdown-content strong { color: #1e293b; }
        .dark .markdown-content strong { color: #cbd5e1; }
        .modal-content .markdown-content p { color: #334155; line-height: 1.6; }
        .dark .modal-content .markdown-content p { color: #cbd5e1; }
        .modal-content .markdown-content h3 { color: #4338ca; border-bottom: 2px solid #c7d2fe; padding-bottom: 4px; margin-top: 16px; }
        .dark .modal-content .markdown-content h3 { color: #a5b4fc; border-bottom-color: #4f46e5; }
        .modal-content .markdown-content strong { color: #4f46e5; }
        .dark .modal-content .markdown-content strong { color: #c7d2fe; }
        .modal-content .markdown-content ul { list-style-position: inside; }
        .modal-content .markdown-content li { color: #475569; margin-bottom: 8px; }
        .dark .modal-content .markdown-content li { color: #94a3b8; }

        .explanation-header {
            padding: 12px;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 12px;
            color: white;
            display: flex;
            align-items: center;
        }
        .explanation-header.correct {
            background-color: #16a34a; /* green-600 */
        }
        .explanation-header.incorrect {
            background-color: #dc2626; /* red-600 */
        }
        .explanation-body ul {
            list-style: none;
            padding: 0;
        }
        /* ‚≠ê UPDATE: New styles for explanation cards */
        .explanation-body li {
            background-color: #fefce8; /* yellow-50 (paper-like) */
            border-left: 4px solid #f97316; /* orange-500 */
            padding: 12px 16px;
            border-radius: 6px;
            margin-bottom: 8px;
            line-height: 1.6;
            color: #3f3f46; /* zinc-700 */
        }
        .dark .explanation-body li {
            background-color: #27211a; /* Darker, warmer paper */
            border-left-color: #fb923c; /* orange-400 */
            color: #d4d4d8; /* zinc-300 */
        }
        .dark .explanation-body li p {
             color: #d4d4d8; /* zinc-300 */
        }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200 flex items-center justify-center min-h-screen p-4 transition-colors duration-500">
    
    <div id="auth-loading-overlay" class="fixed inset-0 bg-slate-100 dark:bg-slate-900 z-50 flex flex-col items-center justify-center">
        <div class="spinner"></div>
        <p class="mt-4 text-slate-600 dark:text-slate-300">ƒêang k·∫øt n·ªëi...</p>
    </div>

    <div id="game-container" class="w-full max-w-2xl mx-auto">
        <div id="question-card" class="bg-white dark:bg-slate-800 rounded-2xl shadow-xl p-6 md:p-8 transition-all duration-300">
            <div id="start-screen" class="text-center">
                 <h1 class="text-3xl md:text-4xl font-bold text-indigo-600 dark:text-indigo-400 mb-2">S·ª± Th·∫≠t hay H∆∞ C·∫•u</h1>
                <p class="text-slate-600 dark:text-slate-300 mb-6">Tr√≤ ch∆°i ki·∫øn th·ª©c ƒë∆∞·ª£c t·∫°o b·ªüi AI Vision</p>
                
                <button id="best-questions-btn" onclick="openTopQuestionsModal()" class="w-full sm:w-auto mb-6 text-lg font-bold py-3 px-6 rounded-lg bg-amber-500 text-white hover:bg-amber-600">üèÜ C√¢u H·ªèi Hay Nh·∫•t</button>
                
                <div id="topic-selection-screen">
                    <h2 class="text-xl font-semibold mb-6">B∆∞·ªõc 1: Ch·ªçn m·ªôt ch·ªß ƒë·ªÅ</h2>
                    <div id="topic-selection" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
                </div>

                <div id="level-selection-screen" class="hidden">
                    <div id="level-buttons-container">
                        <h2 class="text-xl font-semibold mb-6">B∆∞·ªõc 2: Ch·ªçn tr√¨nh ƒë·ªô</h2>
                        <div class="space-y-4">
                            <button onclick="setLevelAndShowPlayModes('easy')" class="level-btn w-full text-lg font-bold py-4 px-6 rounded-lg bg-green-500 text-white">C·∫•p 1 <span class="font-normal text-sm block">(6-10 tu·ªïi)</span></button>
                            <button onclick="setLevelAndShowPlayModes('medium')" class="level-btn w-full text-lg font-bold py-4 px-6 rounded-lg bg-blue-500 text-white">Ph·ªï th√¥ng <span class="font-normal text-sm block">(M·ªçi l·ª©a tu·ªïi)</span></button>
                            <button onclick="setLevelAndShowPlayModes('hard')" class="level-btn w-full text-lg font-bold py-4 px-6 rounded-lg bg-red-500 text-white">Chuy√™n s√¢u <span class="font-normal text-sm block">(Th·ª≠ th√°ch)</span></button>
                        </div>
                        <button onclick="backToTopicSelection()" class="mt-6 text-sm text-indigo-600 dark:text-indigo-400 hover:underline">&larr; Quay l·∫°i ch·ªçn ch·ªß ƒë·ªÅ</button>
                    </div>

                    <div id="play-mode-container" class="hidden">
                        <h2 class="text-xl font-semibold mb-6">B∆∞·ªõc 3: Ch·ªçn ch·∫ø ƒë·ªô ch∆°i</h2>
                        <div class="space-y-4">
                            <button onclick="startGame(false)" class="level-btn w-full text-lg font-bold py-4 px-6 rounded-lg bg-sky-500 text-white">‚ö° Ch∆°i Nhanh <span class="font-normal text-sm block">(∆Øu ti√™n ng√¢n h√†ng c√¢u h·ªèi)</span></button>
                            <button onclick="startGame(true)" class="level-btn w-full text-lg font-bold py-4 px-6 rounded-lg bg-purple-600 text-white">üß† Ch∆°i S√°ng T·∫°o <span class="font-normal text-sm block">(Lu√¥n t·∫°o c√¢u h·ªèi m·ªõi t·ª´ AI)</span></button>
                        </div>
                        <button onclick="backToLevelSelection()" class="mt-6 text-sm text-indigo-600 dark:text-indigo-400 hover:underline">&larr; Quay l·∫°i ch·ªçn tr√¨nh ƒë·ªô</button>
                    </div>
                </div>
            </div>

            <div id="game-ui" class="hidden">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <button onclick="backToMenu()" class="text-sm text-indigo-600 dark:text-indigo-400 hover:underline">&larr; Quay l·∫°i</button>
                        <h1 id="game-title" class="text-xl md:text-2xl font-bold text-indigo-600 dark:text-indigo-400">Ch·ªß ƒë·ªÅ: Ng·∫´u nhi√™n</h1>
                    </div>
                    <div id="score" class="text-lg font-semibold bg-slate-200 dark:bg-slate-700 px-4 py-1 rounded-full">ƒêi·ªÉm: 0</div>
                </div>
                <div class="w-full bg-slate-200 dark:bg-slate-700 rounded-full h-2.5 mb-6">
                    <div id="progress-bar" class="bg-indigo-500 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <p id="question-number" class="text-sm text-slate-500 dark:text-slate-400 mb-2 font-medium"></p>
                <div id="question-area" class="min-h-[100px] md:min-h-[120px] flex items-center justify-center">
                    <h2 id="question-text" class="text-xl md:text-2xl text-center font-semibold">ƒêang t√¨m c√¢u h·ªèi...</h2>
                    <div id="loading-spinner" class="spinner"></div>
                </div>
                <div id="explanation-container" class="mt-4 hidden">
                    <div id="explanation-content"></div>
                    <div class="flex justify-between items-center mt-4 border-t border-slate-200 dark:border-slate-700 pt-4">
                        <!-- ‚≠ê UPDATE: Changed link color to red -->
                        <button onclick="openLearnMoreModal()" class="text-sm font-semibold text-red-600 dark:text-red-500 hover:underline">T√¨m hi·ªÉu s√¢u h∆°n &rarr;</button>
                        <div id="vote-container" class="flex items-center space-x-4">
                            <span class="text-sm text-slate-500 dark:text-slate-400">H·ªØu √≠ch?</span>
                            <button id="like-btn" class="vote-btn text-2xl text-slate-400 hover:text-green-500">üëç</button>
                            <button id="dislike-btn" class="vote-btn text-2xl text-slate-400 hover:text-red-500">üëé</button>
                        </div>
                    </div>
                </div>
                <div id="button-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-6" style="display: none;">
                    <button id="true-btn" onclick="checkAnswer(true)" class="w-full text-lg font-bold py-4 px-6 rounded-lg bg-emerald-500 text-white hover:bg-emerald-600">S·ª± Th·∫≠t</button>
                    <button id="false-btn" onclick="checkAnswer(false)" class="w-full text-lg font-bold py-4 px-6 rounded-lg bg-rose-500 text-white hover:bg-rose-600">H∆∞ C·∫•u</button>
                    <button id="next-btn" onclick="goToNextQuestion()" class="hidden sm:col-span-2 w-full text-lg font-bold py-4 px-6 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">C√¢u ti·∫øp theo</button>
                </div>
            </div>

            <div id="final-score" class="text-center hidden">
                <h2 id="final-title" class="text-3xl md:text-4xl font-bold mb-4">Ho√†n th√†nh!</h2>
                <p class="text-xl mb-2">ƒêi·ªÉm cu·ªëi c√πng c·ªßa b·∫°n:</p>
                <p id="final-score-text" class="text-6xl font-bold text-indigo-600 dark:text-indigo-400 mb-8">0</p>
                <p id="final-message" class="text-lg mb-8"></p>
                <button onclick="resetGame()" class="w-full sm:w-auto text-lg font-bold py-4 px-8 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">Ch∆°i L·∫°i</button>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="learn-more-modal" class="modal-overlay">
        <div class="modal-content">
            <button onclick="closeLearnMoreModal()" class="modal-close-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="text-slate-600 dark:text-slate-300" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"/></svg>
            </button>
            <h2 class="text-2xl font-bold mb-4 text-indigo-600 dark:text-indigo-400">Kh√°m Ph√° S√¢u H∆°n</h2>
            <div id="modal-spinner" class="flex justify-center my-8"><div class="spinner"></div></div>
            <div id="modal-content-area" class="markdown-content"></div>
        </div>
    </div>
    <div id="top-questions-modal" class="modal-overlay">
        <div class="modal-content">
            <button onclick="closeTopQuestionsModal()" class="modal-close-btn">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" class="text-slate-600 dark:text-slate-300" viewBox="0 0 16 16"><path d="M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z"/></svg>
            </button>
            <h2 class="text-2xl font-bold mb-4 text-amber-500 dark:text-amber-400">üèÜ Top 10 C√¢u H·ªèi Hay Nh·∫•t</h2>
            <div id="top-questions-topic-selection" class="mb-4">
                <p class="mb-2 font-semibold">Ch·ªçn ch·ªß ƒë·ªÅ ƒë·ªÉ xem b·∫£ng x·∫øp h·∫°ng:</p>
                <div id="top-questions-topics-list" class="grid grid-cols-2 md:grid-cols-3 gap-3"></div>
            </div>
            <div id="top-questions-content" class="hidden">
                 <button onclick="backToTopTopicSelection()" class="mb-4 text-sm text-indigo-600 dark:text-indigo-400 hover:underline">&larr; Quay l·∫°i ch·ªçn ch·ªß ƒë·ªÅ</button>
                <div id="top-questions-spinner" class="flex justify-center my-8"><div class="spinner"></div></div>
                <div id="top-questions-list"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAI, getGenerativeModel, GoogleAIBackend } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-ai.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, where, doc, setDoc, serverTimestamp, getDoc, increment, writeBatch, orderBy, limit } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDQj9JpV0w3fbfLXWqEaeJ2QkAnnMyeCwU",
            authDomain: "allinone-2b180.firebaseapp.com",
            projectId: "allinone-2b180",
            storageBucket: "allinone-2b180.firebasestorage.app",
            messagingSenderId: "147236185680",
            appId: "1:147236185680:web:dde77438ff630e3210d355"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        let textModel;
        
        const questionSchema = {
            type: "OBJECT",
            properties: {
                statement: { type: "STRING", description: "Ph√°t bi·ªÉu c·ªßa c√¢u ƒë·ªë." },
                answer: { type: "BOOLEAN", description: "ƒê√°p √°n, true cho 'S·ª± th·∫≠t', false cho 'H∆∞ c·∫•u'." },
                explanation: { type: "STRING", description: "M·ªôt b·∫£n t√≥m t·∫Øt gi·∫£i th√≠ch chi ti·∫øt (5-10 d√≤ng) b·∫±ng Markdown, t·∫≠p trung v√†o ki·∫øn th·ª©c. S·ª≠ d·ª•ng 2-3 g·∫°ch ƒë·∫ßu d√≤ng (d√πng '*') ƒë·ªÉ n√™u c√°c √Ω ch√≠nh." },
                subtopic: { type: "STRING", description: "Ch·ªß ƒë·ªÅ con c·ª• th·ªÉ c·ªßa c√¢u h·ªèi n√†y, v√≠ d·ª•: 'L·ªó ƒëen'."}
            },
            required: ["statement", "answer", "explanation", "subtopic"]
        };

        const createQuizGameTool = {
            functionDeclarations: [{
                name: "create_quiz_game",
                description: "T·∫°o m·ªôt b·ªô ƒë·ªÅ 10 c√¢u h·ªèi 'S·ª± th·∫≠t hay H∆∞ c·∫•u' ho√†n ch·ªânh.",
                parameters: {
                    type: "OBJECT",
                    properties: {
                        questions: {
                            type: "ARRAY",
                            description: "M·ªôt m·∫£ng ch·ª©a ch√≠nh x√°c 10 c√¢u ƒë·ªë.",
                            items: questionSchema
                        }
                    },
                    required: ["questions"]
                }
            }]
        };

        try {
            const ai = getAI(app, { backend: new GoogleAIBackend() });
            textModel = getGenerativeModel(ai, { model: "gemini-2.5-flash", tools: createQuizGameTool, toolConfig: { functionCallingConfig: { mode: "ANY" } } });
        } catch (e) { console.error("L·ªói khi kh·ªüi t·∫°o Text Model:", e); }
        
        const TOTAL_QUESTIONS_PER_GAME = 10;
        const topics = [
            { id: 'random', name: 'Ng·∫´u nhi√™n', prompt: 'b·∫•t k·ª≥', color: 'bg-slate-500', subtopics: [] },
            { id: 'space', name: 'V≈© tr·ª•', prompt: 'khoa h·ªçc v≈© tr·ª•', color: 'bg-indigo-500', subtopics: ['C√°c h√†nh tinh trong H·ªá M·∫∑t Tr·ªùi', 'L·ªó ƒëen v√† c√°c hi·ªán t∆∞·ª£ng k·ª≥ l·∫°', 'L·ªãch s·ª≠ du h√†nh v≈© tr·ª•', 'C√°c lo·∫°i thi√™n h√† v√† tinh v√¢n', 'C√°c ng√¥i sao v√† v√≤ng ƒë·ªùi c·ªßa ch√∫ng', 'Ti·ªÉu h√†nh tinh v√† sao ch·ªïi', 'Thuy·∫øt Big Bang', 'S·ª± s·ªëng ngo√†i Tr√°i ƒê·∫•t'] },
            { id: 'animals', name: 'ƒê·ªông v·∫≠t', prompt: 'th·∫ø gi·ªõi ƒë·ªông v·∫≠t', color: 'bg-green-500', subtopics: ['ƒê·ªông v·∫≠t c√≥ v√∫', 'Lo√†i b√≤ s√°t v√† l∆∞·ª°ng c∆∞', 'Sinh v·∫≠t bi·ªÉn', 'C√¥n tr√πng v√† th·∫ø gi·ªõi t√≠ hon', 'C√°c lo√†i ƒë√£ tuy·ªát ch·ªßng', 'C√°c lo√†i chim', 'H√†nh vi k·ª≥ l·∫° c·ªßa ƒë·ªông v·∫≠t'] },
            { id: 'history', name: 'L·ªãch s·ª≠', prompt: 'l·ªãch s·ª≠ th·∫ø gi·ªõi', color: 'bg-amber-600', subtopics: ['C√°c n·ªÅn vƒÉn minh c·ªï ƒë·∫°i', 'C√°c cu·ªôc chi·∫øn tranh th·∫ø gi·ªõi', 'C√°c ph√°t minh thay ƒë·ªïi l·ªãch s·ª≠', 'Nh·ªØng nh√¢n v·∫≠t l·ªãch s·ª≠ b√≠ ·∫©n', 'L·ªãch s·ª≠ Vi·ªát Nam', 'Th·ªùi Trung C·ªï', 'Th·ªùi k·ª≥ Ph·ª•c H∆∞ng'] },
            { id: 'tech', name: 'C√¥ng ngh·ªá', prompt: 'c√¥ng ngh·ªá v√† ph√°t minh', color: 'bg-sky-500', subtopics: ['L·ªãch s·ª≠ m√°y t√≠nh v√† internet', 'Tr√≠ tu·ªá nh√¢n t·∫°o (AI)', 'C√¥ng ngh·ªá ngo√†i kh√¥ng gian', 'C√°c thi·∫øt b·ªã c√¥ng ngh·ªá ƒë·ªôt ph√°', 'An ninh m·∫°ng v√† hacker', 'C√¥ng ngh·ªá th·ª±c t·∫ø ·∫£o (VR/AR)', 'NƒÉng l∆∞·ª£ng t√°i t·∫°o'] },
            { id: 'myth', name: 'Th·∫ßn tho·∫°i', prompt: 'th·∫ßn tho·∫°i v√† truy·ªÅn thuy·∫øt', color: 'bg-purple-500', subtopics: ['Th·∫ßn tho·∫°i Hy L·∫°p v√† La M√£', 'Th·∫ßn tho·∫°i Ai C·∫≠p', 'Th·∫ßn tho·∫°i B·∫Øc √Çu', 'C√°c sinh v·∫≠t huy·ªÅn tho·∫°i', 'Truy·ªÅn thuy·∫øt ƒë√¥ th·ªã hi·ªán ƒë·∫°i', 'Th·∫ßn tho·∫°i Nh·∫≠t B·∫£n', 'Vua Arthur v√† c√°c hi·ªáp sƒ©'] },
            { id: 'geography', name: 'ƒê·ªãa l√Ω', prompt: 'ƒë·ªãa l√Ω th·∫ø gi·ªõi', color: 'bg-emerald-500', subtopics: ['C√°c k·ª≥ quan thi√™n nhi√™n th·∫ø gi·ªõi', 'Nh·ªØng con s√¥ng v√† ng·ªçn n√∫i cao nh·∫•t', 'C√°c hi·ªán t∆∞·ª£ng th·ªùi ti·∫øt c·ª±c ƒëoan', 'C√°c sa m·∫°c v√† r·ª´ng r·∫≠m l·ªõn nh·∫•t', 'ƒê·ªãa l√Ω c√°c qu·ªëc gia ƒë·∫∑c bi·ªát', 'C√°c ƒë·∫°i d∆∞∆°ng tr√™n th·∫ø gi·ªõi', 'C√°c th√†nh ph·ªë b·ªã l√£ng qu√™n'] },
        ];
        
        let userId = null;
        let userHistory = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let currentQuestion = null;
        let selectedTopic = topics[0];
        let selectedLevel = 'medium';
        let currentGameSession = [];
        let currentTopicForGame = null;

        const domElements = {
            authLoadingOverlay: document.getElementById('auth-loading-overlay'),
            startScreen: document.getElementById('start-screen'),
            topicSelectionScreen: document.getElementById('topic-selection-screen'),
            levelSelectionScreen: document.getElementById('level-selection-screen'),
            levelButtonsContainer: document.getElementById('level-buttons-container'),
            playModeContainer: document.getElementById('play-mode-container'),
            questionCard: document.getElementById('question-card'),
            questionText: document.getElementById('question-text'),
            questionNumberText: document.getElementById('question-number'),
            scoreText: document.getElementById('score'),
            explanationContainer: document.getElementById('explanation-container'),
            explanationContent: document.getElementById('explanation-content'),
            buttonContainer: document.getElementById('button-container'),
            progressBar: document.getElementById('progress-bar'),
            loadingSpinner: document.getElementById('loading-spinner'),
            gameUI: document.getElementById('game-ui'),
            finalScoreScreen: document.getElementById('final-score'),
            finalScoreText: document.getElementById('final-score-text'),
            finalMessage: document.getElementById('final-message'),
            topicSelectionContainer: document.getElementById('topic-selection'),
            gameTitle: document.getElementById('game-title'),
            trueBtn: document.getElementById('true-btn'),
            falseBtn: document.getElementById('false-btn'),
            nextBtn: document.getElementById('next-btn'),
            learnMoreModal: document.getElementById('learn-more-modal'),
            modalSpinner: document.getElementById('modal-spinner'),
            modalContentArea: document.getElementById('modal-content-area'),
            voteContainer: document.getElementById('vote-container'),
            likeBtn: document.getElementById('like-btn'),
            dislikeBtn: document.getElementById('dislike-btn'),
            topQuestionsModal: document.getElementById('top-questions-modal'),
            topQuestionsTopicSelection: document.getElementById('top-questions-topic-selection'),
            topQuestionsTopicsList: document.getElementById('top-questions-topics-list'),
            topQuestionsContent: document.getElementById('top-questions-content'),
            topQuestionsSpinner: document.getElementById('top-questions-spinner'),
            topQuestionsList: document.getElementById('top-questions-list'),
        };
        
        async function loadUserHistory() {
            if (!userId) return;
            userHistory = [];
            const historyCollectionRef = collection(db, 'users', userId, 'gameHistory');
            try {
                const querySnapshot = await getDocs(historyCollectionRef);
                querySnapshot.forEach(doc => userHistory.push(doc.id));
            } catch (error) { console.error("L·ªói khi t·∫£i l·ªãch s·ª≠ ng∆∞·ªùi d√πng:", error); }
        }
        
        async function updateUserHistory(questionId, topicId) {
            if (!userId || !questionId || !topicId) return;
            const historyDocId = `${topicId}_${questionId}`;
            if (userHistory.includes(historyDocId)) return;
            
            const historyDocRef = doc(db, 'users', userId, 'gameHistory', historyDocId);
            try {
                await setDoc(historyDocRef, { playedAt: serverTimestamp() });
                userHistory.push(historyDocId);
            } catch (error) { console.error("L·ªói khi c·∫≠p nh·∫≠t l·ªãch s·ª≠ ng∆∞·ªùi d√πng:", error); }
        }
        
        async function cacheAndGetIdsForNewQuestions(questions, topic, level) {
            const batch = writeBatch(db);
            const collectionName = `${topic.id}_questions`;
            const questionsWithIds = [];

            for (const q of questions) {
                const newDocRef = doc(collection(db, collectionName));
                batch.set(newDocRef, { 
                    ...q, 
                    level: level, 
                    createdAt: serverTimestamp(),
                    likes: 0,
                    dislikes: 0
                });
                questionsWithIds.push({ ...q, id: newDocRef.id, topicId: topic.id });
            }
            
            await batch.commit();
            console.log(`ƒê√£ l∆∞u ${questions.length} c√¢u h·ªèi m·ªõi v√† g√°n ID.`);

            if (questions.length > 0 && topic.id !== 'random') {
                const countKey = `${topic.id}_${level}`;
                const metadataRef = doc(db, '_metadata', 'questionCounts');
                try {
                    await setDoc(metadataRef, { [countKey]: increment(questions.length) }, { merge: true });
                    console.log(`Metadata updated: ${countKey} incremented by ${questions.length}`);
                } catch(error) {
                    console.error("L·ªói khi c·∫≠p nh·∫≠t metadata:", error);
                }
            }

            return questionsWithIds;
        }

        async function getQuestionsFromCache(topic, level) {
            if (topic.id === 'random') return [];
            console.log(`ƒêang t√¨m ${TOTAL_QUESTIONS_PER_GAME} c√¢u h·ªèi ch∆∞a ch∆°i trong cache...`);
            const collectionName = `${topic.id}_questions`;
            const q = query(collection(db, collectionName), where("level", "==", level));
            
            try {
                const querySnapshot = await getDocs(q);
                const allQuestions = [];
                querySnapshot.forEach(doc => {
                    allQuestions.push({ id: doc.id, topicId: topic.id, ...doc.data() });
                });

                const playedIdsForTopic = userHistory.filter(h => h.startsWith(`${topic.id}_`));
                const unseenQuestions = allQuestions.filter(q => !playedIdsForTopic.includes(`${topic.id}_${q.id}`));

                if (unseenQuestions.length >= TOTAL_QUESTIONS_PER_GAME) {
                    for (let i = unseenQuestions.length - 1; i > 0; i--) {
                        const j = Math.floor(Math.random() * (i + 1));
                        [unseenQuestions[i], unseenQuestions[j]] = [unseenQuestions[j], unseenQuestions[i]];
                    }
                    console.log(`T√¨m th·∫•y ${unseenQuestions.length} c√¢u ch∆∞a ch∆°i. L·∫•y 10 c√¢u ng·∫´u nhi√™n.`);
                    return unseenQuestions.slice(0, TOTAL_QUESTIONS_PER_GAME);
                } else {
                     console.log(`Kh√¥ng ƒë·ªß c√¢u ch∆∞a ch∆°i trong cache (${unseenQuestions.length}). S·∫Ω g·ªçi AI.`);
                    return [];
                }
            } catch (error) {
                console.error("L·ªói khi l·∫•y c√¢u h·ªèi t·ª´ cache:", error);
                return [];
            }
        }
        
        async function getExistingQuestionSamples(topic, level, count = 25) {
            if (topic.id === 'random') return [];
            const collectionName = `${topic.id}_questions`;
            const q = query(collection(db, collectionName), where("level", "==", level), limit(count * 2));
            try {
                const querySnapshot = await getDocs(q);
                const statements = [];
                querySnapshot.forEach(doc => {
                    statements.push(doc.data().statement);
                });
                for (let i = statements.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [statements[i], statements[j]] = [statements[j], statements[i]];
                }
                return statements.slice(0, count);
            } catch (error) {
                console.error("L·ªói khi l·∫•y m·∫´u c√¢u h·ªèi:", error);
                return [];
            }
        }

        async function generateFullGameSession(topic, level, existingSamples = []) {
            let levelDescription = '';
            switch(level) {
                case 'easy': levelDescription = 'd·ªÖ, ph√π h·ª£p cho tr·∫ª em 6-10 tu·ªïi'; break;
                case 'hard': levelDescription = 'kh√≥ v√† chuy√™n s√¢u, d√†nh cho chuy√™n gia'; break;
                default: levelDescription = 'ph·ªï th√¥ng, ph√π h·ª£p v·ªõi m·ªçi l·ª©a tu·ªïi'; break;
            }

            let subtopicPool = [...(topic.subtopics || [])];
            let selectedSubtopics = [];
            if (topic.id !== 'random' && subtopicPool.length > 0) {
                 for (let i = 0; i < TOTAL_QUESTIONS_PER_GAME; i++) {
                    if (subtopicPool.length === 0) subtopicPool = [...(topic.subtopics)];
                    const randomIndex = Math.floor(Math.random() * subtopicPool.length);
                    selectedSubtopics.push(subtopicPool.splice(randomIndex, 1)[0]);
                }
            }
           
            const subtopicsString = selectedSubtopics.join(', ');
            
            const uniquenessInstruction = existingSamples.length > 0
                ? `8.  **ƒê·ªòC NH·∫§T TUY·ªÜT ƒê·ªêI:** D∆∞·ªõi ƒë√¢y l√† danh s√°ch m·ªôt s·ªë c√¢u h·ªèi ƒë√£ c√≥ s·∫µn. **TUY·ªÜT ƒê·ªêI KH√îNG** t·∫°o l·∫°i c√°c c√¢u h·ªèi c√≥ c√πng n·ªôi dung ho·∫∑c √Ω t∆∞·ªüng t∆∞∆°ng t·ª±:\n- ${existingSamples.join('\n- ')}`
                : '';

            const prompt = `H√£y ƒë√≥ng vai m·ªôt nh√† s·∫£n xu·∫•t game show ki·∫øn th·ª©c "S·ª± Th·∫≠t hay H∆∞ C·∫•u" c·ª±c k·ª≥ s√°ng t·∫°o.
Nhi·ªám v·ª• c·ªßa b·∫°n l√† thi·∫øt k·∫ø m·ªôt k·ªãch b·∫£n ho√†n ch·ªânh g·ªìm ${TOTAL_QUESTIONS_PER_GAME} c√¢u h·ªèi cho m·ªôt t·∫≠p ph√°t s√≥ng.
**Y√™u c·∫ßu K·ªäCH B·∫¢N:**
1.  **Ch·ªß ƒê·ªÅ Ch√≠nh:** ${topic.prompt}.
2.  **Tr√¨nh ƒê·ªô:** ${levelDescription}.
3.  **ƒêA D·∫†NG TUY·ªÜT ƒê·ªêI:** ${subtopicsString ? `T·∫°o m·ªói c√¢u h·ªèi d·ª±a tr√™n m·ªôt trong c√°c ch·ªß ƒë·ªÅ con sau: ${subtopicsString}. **KH√îNG ƒë∆∞·ª£c l·∫∑p l·∫°i ch·ªß ƒë·ªÅ con.**` : 'T·∫°o c√°c c√¢u h·ªèi th·∫≠t ƒëa d·∫°ng trong ch·ªß ƒë·ªÅ ch√≠nh.'}
4.  **C√ÇN B·∫∞NG HO√ÄN H·∫¢O:** B·ªô ƒë·ªÅ ph·∫£i c√≥ t·ªâ l·ªá g·∫ßn b·∫±ng nhau gi·ªØa c√¢u "S·ª± th·∫≠t" v√† "H∆∞ c·∫•u".
5.  **CH·∫§T L∆Ø·ª¢NG V∆Ø·ª¢T TR·ªòI:**
    * **C√¢u "S·ª± th·∫≠t"** ph·∫£i g√¢y ng·∫°c nhi√™n, ƒëi ng∆∞·ª£c l·∫°i suy nghƒ© th√¥ng th∆∞·ªùng.
    * **C√¢u "H∆∞ c·∫•u"** ph·∫£i d·ª±a tr√™n m·ªôt l·∫ßm t∆∞·ªüng ph·ªï bi·∫øn ho·∫∑c m·ªôt s·ª± th·∫≠t b·ªã b√≥p m√©o tinh vi ƒë·ªÉ nghe c·ª±c k·ª≥ h·ª£p l√Ω.
6.  **GI·∫¢I TH√çCH CH·∫§T L∆Ø·ª¢NG:** V·ªõi m·ªói c√¢u h·ªèi, ph·∫ßn 'explanation' ph·∫£i l√† m·ªôt ƒëo·∫°n t√≥m t·∫Øt s√∫c t√≠ch (5-10 d√≤ng) b·∫±ng **Markdown**, t·∫≠p trung v√†o ki·∫øn th·ª©c. S·ª≠ d·ª•ng **2-3 g·∫°ch ƒë·∫ßu d√≤ng (d√πng d·∫•u \`*\`)** ƒë·ªÉ n√™u b·∫≠t nh·ªØng s·ª± th·∫≠t th√∫ v·ªã ho·∫∑c l√Ω do ch√≠nh. ƒê√¢y l√† b·∫£n t√≥m t·∫Øt cho l·ªùi gi·∫£i th√≠ch s√¢u h∆°n.
7.  **KH√îNG TR√ôNG L·∫∂P:** ƒê·∫£m b·∫£o 10 c√¢u h·ªèi kh√¥ng tr√πng l·∫∑p v·ªÅ √Ω t∆∞·ªüng v·ªõi nhau.
${uniquenessInstruction}
H√£y t·∫°o ra m·ªôt b·ªô ƒë·ªÅ th·∫≠t "hack n√£o" v√† th√∫ v·ªã! G·ªçi c√¥ng c·ª• \`create_quiz_game\` v·ªõi k·∫øt qu·∫£ c·ªßa b·∫°n.`;

            try {
                const result = await textModel.generateContent(prompt);
                const functionCalls = result.response.functionCalls();
                if (functionCalls && functionCalls[0]?.name === "create_quiz_game") {
                    const gameData = functionCalls[0].args;
                    if (gameData.questions && gameData.questions.length >= TOTAL_QUESTIONS_PER_GAME) {
                        return gameData.questions.slice(0, TOTAL_QUESTIONS_PER_GAME);
                    }
                }
                throw new Error("AI kh√¥ng tr·∫£ v·ªÅ b·ªô ƒë·ªÅ h·ª£p l·ªá.");
            } catch (error) {
                console.error("L·ªói khi t·∫°o b·ªô ƒë·ªÅ:", error);
                return null;
            }
        }
        
        function showLoading(isLoading, message = '') {
            if (isLoading) {
                domElements.questionText.textContent = message;
                domElements.loadingSpinner.style.display = 'block';
                domElements.buttonContainer.style.display = 'none';
            } else {
                domElements.loadingSpinner.style.display = 'none';
                domElements.buttonContainer.style.display = 'grid';
            }
        }

        async function startGame(forceAI = false) {
            domElements.startScreen.style.display = 'none';
            domElements.gameUI.style.display = 'block';
            
            currentQuestionIndex = 0;
            score = 0;
            currentGameSession = [];
            updateScore();
            
            showLoading(true, `ƒêang chu·∫©n b·ªã b·ªô ƒë·ªÅ...`);

            currentTopicForGame = selectedTopic.id === 'random' ? topics[Math.floor(Math.random() * (topics.length - 1)) + 1] : selectedTopic;
            
            const displayTopicName = currentTopicForGame.name;
            domElements.gameTitle.textContent = `Ch·ªß ƒë·ªÅ: ${displayTopicName} - ${levelNames[selectedLevel]}`; 

            let questions = [];

            if (!forceAI) {
                questions = await getQuestionsFromCache(currentTopicForGame, selectedLevel);
            }
            
            if (questions.length < TOTAL_QUESTIONS_PER_GAME) {
                const loadingMessage = forceAI ? `ƒêang nh·ªù AI t·∫°o b·ªô ƒë·ªÅ s√°ng t·∫°o...` : `Cache kh√¥ng ƒë·ªß, ƒëang nh·ªù AI t·∫°o b·ªô ƒë·ªÅ m·ªõi...`;
                showLoading(true, loadingMessage);
                
                const samples = forceAI ? await getExistingQuestionSamples(currentTopicForGame, selectedLevel) : [];
                const newQuestionsFromAI = await generateFullGameSession(currentTopicForGame, selectedLevel, samples);

                if (newQuestionsFromAI && newQuestionsFromAI.length > 0) {
                    questions = await cacheAndGetIdsForNewQuestions(newQuestionsFromAI, currentTopicForGame, selectedLevel);
                }
            }
            
            if (questions && questions.length > 0) {
                currentGameSession = questions;
                displayQuestion();
            } else {
                showLoading(false);
                domElements.questionText.textContent = "Kh√¥ng th·ªÉ t·∫°o b·ªô ƒë·ªÅ. Vui l√≤ng th·ª≠ l·∫°i.";
            }
        }
        
        function displayQuestion() {
            if (currentQuestionIndex >= currentGameSession.length) {
                showFinalScore();
                return;
            }
            currentQuestion = currentGameSession[currentQuestionIndex];
            
            domElements.likeBtn.className = 'vote-btn text-2xl text-slate-400 hover:text-green-500';
            domElements.dislikeBtn.className = 'vote-btn text-2xl text-slate-400 hover:text-red-500';
            domElements.likeBtn.disabled = false;
            domElements.dislikeBtn.disabled = false;
            domElements.likeBtn.onclick = () => voteOnQuestion('like');
            domElements.dislikeBtn.onclick = () => voteOnQuestion('dislike');

            domElements.questionCard.classList.remove('card-enter-active', 'feedback-correct', 'feedback-incorrect');
            setTimeout(() => domElements.questionCard.classList.add('card-enter-active'), 50);
            domElements.explanationContainer.style.display = 'none';
            domElements.trueBtn.style.display = 'block';
            domElements.falseBtn.style.display = 'block';
            domElements.nextBtn.style.display = 'none';
            showLoading(false);
            domElements.questionText.innerHTML = marked.parseInline(currentQuestion.statement);
            domElements.questionNumberText.textContent = `C√¢u h·ªèi ${currentQuestionIndex + 1} tr√™n ${TOTAL_QUESTIONS_PER_GAME}`;
            domElements.progressBar.style.width = `${((currentQuestionIndex + 1) / TOTAL_QUESTIONS_PER_GAME) * 100}%`;
            
            updateUserHistory(currentQuestion.id, currentQuestion.topicId);
        }
        
        async function voteOnQuestion(voteType) {
            if (!currentQuestion || !currentQuestion.id || !currentQuestion.topicId) return;
            
            domElements.likeBtn.disabled = true;
            domElements.dislikeBtn.disabled = true;

            const collectionName = `${currentQuestion.topicId}_questions`;
            const questionRef = doc(db, collectionName, currentQuestion.id);
            const fieldToUpdate = voteType === 'like' ? 'likes' : 'dislikes';

            try {
                await setDoc(questionRef, { [fieldToUpdate]: increment(1) }, { merge: true });
                console.log(`Vote '${voteType}' th√†nh c√¥ng cho c√¢u h·ªèi ${currentQuestion.id}`);
                if (voteType === 'like') {
                    domElements.likeBtn.classList.add('voted-like');
                } else {
                    domElements.dislikeBtn.classList.add('voted-dislike');
                }
            } catch (error) {
                console.error("L·ªói khi vote:", error);
                domElements.likeBtn.disabled = false;
                domElements.dislikeBtn.disabled = false;
            }
        }
        
        function openTopQuestionsModal() {
            domElements.topQuestionsModal.classList.add('active');
            domElements.topQuestionsContent.style.display = 'none';
            domElements.topQuestionsTopicSelection.style.display = 'block';
            if(domElements.topQuestionsTopicsList.childElementCount === 0) {
                 topics.filter(t => t.id !== 'random').forEach(topic => {
                    const button = document.createElement('button');
                    button.textContent = topic.name;
                    button.className = `w-full text-md font-bold py-3 px-2 rounded-lg text-white ${topic.color}`;
                    button.onclick = () => selectTopQuestionTopic(topic);
                    domElements.topQuestionsTopicsList.appendChild(button);
                });
            }
        }

        function closeTopQuestionsModal() {
            domElements.topQuestionsModal.classList.remove('active');
        }

        function backToTopTopicSelection() {
             domElements.topQuestionsContent.style.display = 'none';
             domElements.topQuestionsTopicSelection.style.display = 'block';
        }

        async function selectTopQuestionTopic(topic) {
            domElements.topQuestionsTopicSelection.style.display = 'none';
            domElements.topQuestionsContent.style.display = 'block';
            domElements.topQuestionsList.innerHTML = '';
            domElements.topQuestionsSpinner.style.display = 'flex';

            const collectionName = `${topic.id}_questions`;
            const q = query(collection(db, collectionName), orderBy('likes', 'desc'), limit(10));

            try {
                const querySnapshot = await getDocs(q);
                domElements.topQuestionsSpinner.style.display = 'none';
                if (querySnapshot.empty) {
                    domElements.topQuestionsList.innerHTML = '<p>Ch∆∞a c√≥ c√¢u h·ªèi n√†o ƒë∆∞·ª£c x·∫øp h·∫°ng cho ch·ªß ƒë·ªÅ n√†y.</p>';
                    return;
                }
                let rank = 1;
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    const questionEl = document.createElement('div');
                    questionEl.className = 'p-4 border-b dark:border-slate-700';
                    questionEl.innerHTML = `
                        <p class="font-semibold text-lg">${rank}. ${data.statement}</p>
                        <p class="text-sm mt-1">üëç ${data.likes || 0} L∆∞·ª£t th√≠ch</p>
                        <details class="mt-2 text-sm">
                            <summary class="cursor-pointer text-indigo-600 dark:text-indigo-400">Xem ƒë√°p √°n & gi·∫£i th√≠ch</summary>
                            <div class="mt-2 p-3 bg-slate-100 dark:bg-slate-700 rounded-md markdown-content">
                                <p><strong>ƒê√°p √°n:</strong> ${data.answer ? 'S·ª± th·∫≠t' : 'H∆∞ c·∫•u'}</p>
                                <div class="mt-1">${marked.parse(data.explanation)}</div>
                            </div>
                        </details>
                    `;
                    domElements.topQuestionsList.appendChild(questionEl);
                    rank++;
                });
            } catch (error) {
                console.error("L·ªói khi l·∫•y top 10:", error);
                domElements.topQuestionsSpinner.style.display = 'none';
                domElements.topQuestionsList.innerHTML = '<p class="text-red-500">Kh√¥ng th·ªÉ t·∫£i b·∫£ng x·∫øp h·∫°ng. Vui l√≤ng th·ª≠ l·∫°i.</p>';
            }
        }
        
        function initAuth() {
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    await loadUserHistory();
                } else {
                    try {
                        const userCredential = await signInAnonymously(auth);
                        userId = userCredential.user.uid;
                        await loadUserHistory();
                    } catch (error) {
                        domElements.authLoadingOverlay.innerHTML = '<p class="text-red-500 font-semibold">L·ªói k·∫øt n·ªëi.</p>';
                        return;
                    }
                }
                domElements.authLoadingOverlay.style.display = 'none';
            });
        }
        
        const levelNames = { 
            easy: 'C·∫•p 1', 
            medium: 'Ph·ªï th√¥ng', 
            hard: 'Chuy√™n s√¢u' 
        };
        
        function backToMenu() {
            domElements.gameUI.style.display = 'none';
            domElements.finalScoreScreen.style.display = 'none';
            domElements.startScreen.style.display = 'block';
            domElements.levelSelectionScreen.style.display = 'none';
            domElements.topicSelectionScreen.style.display = 'block';
        }
        
        function selectTopic(id) { 
            selectedTopic = topics.find(t => t.id === id); 
            domElements.topicSelectionScreen.style.display = 'none'; 
            domElements.levelSelectionScreen.style.display = 'block'; 
            domElements.playModeContainer.style.display = 'none';
            domElements.levelButtonsContainer.style.display = 'block';
        }

        function setLevelAndShowPlayModes(level) {
            selectedLevel = level;
            domElements.levelButtonsContainer.style.display = 'none';
            domElements.playModeContainer.style.display = 'block';
        }

        function backToLevelSelection() {
            domElements.playModeContainer.style.display = 'none';
            domElements.levelButtonsContainer.style.display = 'block';
        }
        
        function backToTopicSelection() { 
            domElements.levelSelectionScreen.style.display = 'none'; 
            domElements.topicSelectionScreen.style.display = 'block'; 
        }
        
        function resetGame() { 
            domElements.finalScoreScreen.style.display = 'none'; 
            backToMenu(); 
        }
        
        function checkAnswer(userAnswer) {
            if (!currentQuestion) return;
            domElements.trueBtn.style.display = 'none';
            domElements.falseBtn.style.display = 'none';
            domElements.nextBtn.style.display = 'block';
            const isCorrect = currentQuestion.answer === userAnswer;
            if (isCorrect) {
                score++;
                domElements.questionCard.classList.add("feedback-correct");
            } else {
                domElements.questionCard.classList.add("feedback-incorrect");
            }
            updateScore();
            showExplanation();
        }
        
        function goToNextQuestion() {
            currentQuestionIndex++;
            displayQuestion();
        }
        
        function showExplanation() {
            const isCorrectAnswer = currentQuestion.answer;
            const headerText = isCorrectAnswer ? "‚úÖ ƒê√∫ng v·∫≠y, ƒë√≥ l√† S·ª± th·∫≠t!" : "‚ùå Ch√≠nh x√°c, ƒë√≥ l√† H∆∞ c·∫•u!";
            const headerClass = isCorrectAnswer ? 'correct' : 'incorrect';

            const explanationHTML = `
                <div class="explanation-header ${headerClass}">
                    ${headerText}
                </div>
                <div class="explanation-body markdown-content">
                    ${marked.parse(currentQuestion.explanation)}
                </div>
            `;
            
            domElements.explanationContent.innerHTML = explanationHTML;
            domElements.explanationContainer.style.display = "block";
        }
        
        function updateScore() {
            domElements.scoreText.innerHTML = `ƒêi·ªÉm: ${score}`;
        }
        
        function showFinalScore() {
            domElements.gameUI.style.display = "none";
            domElements.finalScoreScreen.style.display = "block";
            domElements.finalScoreText.textContent = score;
            let message = "C·ªë g·∫Øng h∆°n nh√©! C√≤n nhi·ªÅu ƒëi·ªÅu th√∫ v·ªã ƒë·ªÉ kh√°m ph√°.";
            const percentage = (score / TOTAL_QUESTIONS_PER_GAME) * 100;
            if (percentage === 100) {
                message = "Tuy·ªát v·ªùi! B·∫°n l√† m·ªôt b·∫≠c th·∫ßy s·ª± th·∫≠t!";
            } else if (percentage >= 75) {
                message = "L√†m t·ªët l·∫Øm! Ki·∫øn th·ª©c c·ªßa b·∫°n th·∫≠t ƒë√°ng n·ªÉ.";
            } else if (percentage >= 50) {
                message = "Kh√¥ng t·ªá! B·∫°n ƒë√£ ph√¢n bi·ªát ƒë∆∞·ª£c kh√° nhi·ªÅu s·ª± th·∫≠t.";
            }
            domElements.finalMessage.textContent = message;
        }
        
        function openLearnMoreModal() {
            domElements.learnMoreModal.classList.add("active");
            domElements.modalContentArea.innerHTML="";
            domElements.modalSpinner.style.display="flex";
            generateDetailedExplanation(selectedLevel).then(detailedExplanation => {
                domElements.modalSpinner.style.display="none";
                if(detailedExplanation){
                    domElements.modalContentArea.innerHTML=marked.parse(detailedExplanation)
                } else {
                    domElements.modalContentArea.innerHTML=`
                        <div class="text-center">
                            <p class="text-red-500 font-semibold">R·∫•t ti·∫øc, kh√¥ng th·ªÉ t·∫°o n·ªôi dung.</p>
                            <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">ƒê√£ c√≥ l·ªói x·∫£y ra trong qu√° tr√¨nh x·ª≠ l√Ω. Vui l√≤ng th·ª≠ l·∫°i.</p>
                            <button onclick="openLearnMoreModal()" class="mt-4 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm font-semibold">
                                Th·ª≠ l·∫°i
                            </button>
                        </div>
                    `;
                }
            });
        }
        
        async function generateDetailedExplanation(level) {
            if (!textModel || !currentQuestion) return null;
            
            let levelInstruction = '';
            switch(level) {
                case 'easy':
                    levelInstruction = 'H√£y gi·∫£i th√≠ch nh∆∞ ƒëang n√≥i v·ªõi m·ªôt ƒë·ª©a tr·∫ª 8 tu·ªïi. D√πng t·ª´ ng·ªØ c·ª±c k·ª≥ ƒë∆°n gi·∫£n, c√°c c√¢u ng·∫Øn g·ªçn, v√† c√°c v√≠ d·ª• g·∫ßn g≈©i, d·ªÖ h√¨nh dung. Tr√°nh m·ªçi thu·∫≠t ng·ªØ ph·ª©c t·∫°p.';
                    break;
                case 'hard':
                    levelInstruction = 'H√£y ƒëi s√¢u v√†o c√°c chi ti·∫øt k·ªπ thu·∫≠t, c√°c thu·∫≠t ng·ªØ chuy√™n ng√†nh, v√† c√°c b·ªëi c·∫£nh l·ªãch s·ª≠ ho·∫∑c khoa h·ªçc ph·ª©c t·∫°p li√™n quan.';
                    break;
                default:
                    levelInstruction = 'H√£y gi·∫£i th√≠ch m·ªôt c√°ch r√µ r√†ng, m·∫°ch l·∫°c cho ƒë·ªëi t∆∞·ª£ng ph·ªï th√¥ng, cung c·∫•p th√™m c√°c th√¥ng tin th√∫ v·ªã v√† m·ªü r·ªông ki·∫øn th·ª©c.';
                    break;

            }

            const chatModel = getGenerativeModel(getAI(app,{backend:new GoogleAIBackend}),{model:"gemini-2.5-flash"});
            const prompt = `H√£y ƒë√≥ng vai m·ªôt chuy√™n gia uy√™n b√°c. D·ª±a tr√™n ph√°t bi·ªÉu sau: "${currentQuestion.statement}", h√£y cung c·∫•p m·ªôt b√†i gi·∫£i th√≠ch chi ti·∫øt, s√¢u s·∫Øc v√† th√∫ v·ªã b·∫±ng ti·∫øng Vi·ªát. ${levelInstruction} M·ªü r·ªông t·ª´ l·ªùi gi·∫£i th√≠ch ng·∫Øn g·ªçn ban ƒë·∫ßu: "${currentQuestion.explanation}". S·ª≠ d·ª•ng ƒë·ªãnh d·∫°ng Markdown.`;
            try {
                const result = await chatModel.generateContent(prompt);
                return result.response.text();
            } catch(error) {
                console.error("L·ªói khi t·∫°o gi·∫£i th√≠ch chi ti·∫øt:", error);
                return null;
            }
        }
        
        function closeLearnMoreModal() {
            domElements.learnMoreModal.classList.remove('active');
        }
        
        window.openTopQuestionsModal = openTopQuestionsModal;
        window.closeTopQuestionsModal = closeTopQuestionsModal;
        window.backToTopTopicSelection = backToTopTopicSelection;
        window.selectTopQuestionTopic = selectTopQuestionTopic;
        window.backToMenu = backToMenu;
        window.selectTopic = selectTopic;
        window.setLevelAndShowPlayModes = setLevelAndShowPlayModes;
        window.backToLevelSelection = backToLevelSelection;
        window.backToTopicSelection = backToTopicSelection;
        window.startGame = startGame;
        window.checkAnswer = checkAnswer;
        window.goToNextQuestion = goToNextQuestion;
        window.resetGame = resetGame;
        window.openLearnMoreModal = openLearnMoreModal;
        window.closeLearnMoreModal = closeLearnMoreModal;
        
        function completeInit() {
            topics.forEach(topic => {
                const button = document.createElement('button');
                button.textContent = topic.name;
                button.className = `topic-btn w-full text-lg font-bold py-6 px-4 rounded-lg text-white ${topic.color}`;
                button.onclick = () => selectTopic(topic.id);
                domElements.topicSelectionContainer.appendChild(button);
            });
            domElements.learnMoreModal.addEventListener('click', (event) => {
                if (event.target === domElements.learnMoreModal) closeLearnMoreModal();
            });
             domElements.topQuestionsModal.addEventListener('click', (event) => {
                if (event.target === domElements.topQuestionsModal) closeTopQuestionsModal();
            });
            initAuth();
        }

        completeInit();
    </script>
</body>
</html>

